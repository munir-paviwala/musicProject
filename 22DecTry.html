<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audio Map (Debug Mode)</title>
    <style>
        body { margin: 0; background: #050505; color: white; font-family: 'Helvetica Neue', sans-serif; overflow: hidden; }
        #canvas { display: block; cursor: grab; }
        #canvas:active { cursor: grabbing; }
        
        /* UI Layer */
        #ui { position: absolute; top: 20px; left: 20px; pointer-events: none; mix-blend-mode: difference; z-index: 10; }
        
        /* The "Start" Overlay - Crucial for Audio Permissions */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 999;
        }
        #start-btn {
            padding: 15px 40px; font-size: 1.2em; cursor: pointer;
            background: white; border: none; border-radius: 50px; font-weight: bold;
            transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.1); }

        /* The Player UI */
        #now-playing {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 300px;
            background: rgba(20, 20, 20, 0.85); 
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 20px; 
            display: none; 
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            z-index: 100;
        }

        #np-title { font-weight: 700; font-size: 1.1em; margin-bottom: 5px; color: #fff; }
        #np-note { font-size: 0.85em; color: #aaa; line-height: 1.4; margin-bottom: 10px; font-style: italic;}
        #debug-log { position: absolute; bottom: 10px; left: 10px; font-family: monospace; font-size: 10px; color: #555; pointer-events: none; }
        
        /* Hide the iframes */
        #yt-container { position: absolute; top: 0; left: 0; opacity: 0; pointer-events: none; z-index: -1; }
    </style>
</head>
<body>

<div id="start-screen">
    <h1>The Sonic Archive</h1>
    <p style="color: #aaa; margin-bottom: 20px;">Headphones Recommended</p>
    <button id="start-btn">ENTER GALLERY</button>
</div>

<div id="ui">
    <h2>Phase 6: Inverted Drag</h2>
    <p>Drag map to move | Scroll to Zoom</p>
</div>

<div id="now-playing">
    <div id="np-title">Song Title</div>
    <div id="np-note">Note</div>
</div>

<div id="debug-log">Waiting for API...</div>

<div id="yt-container"></div>

<canvas id="canvas"></canvas>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const npBox = document.getElementById('now-playing');
const npTitle = document.getElementById('np-title');
const npNote = document.getElementById('np-note');
const debug = document.getElementById('debug-log');
const startScreen = document.getElementById('start-screen');
const startBtn = document.getElementById('start-btn');

// ==========================================
// 1. DATA
// ==========================================
const anchors = [
    { x: 0, y: 0, color: "#ff4400", radius: 900 }, 
    { x: -400, y: -400, color: "#220033", radius: 800 } 
];

const songs = [
    { id: "AP1", ytId: "LlJxnlFDRz4", x: 0, y: -150, title: "After Midnight", note: "Late night driving vibes.", offset: Math.random()*100 },
    { id: "AP2", ytId: "Vd7F5VHz5BI", x: -140, y: 100, title: "All Night (Live)", note: "Raw energy.", offset: Math.random()*100 },
    { id: "AP3", ytId: "N8dexd1PqEw", x: 140, y: 100, title: "By My Side", note: "Melodic and soft.", offset: Math.random()*100 }
];

// ==========================================
// 2. YOUTUBE ENGINE (Robust)
// ==========================================
let ytPlayers = {};
let apiReady = false;
let userHasInteracted = false; // Essential for browser policy

function onYouTubeIframeAPIReady() {
    debug.innerText = "API Loaded. Building players...";
    apiReady = true;
    
    songs.forEach(song => {
        const divId = `yt-player-${song.id}`;
        const p = document.createElement('div');
        p.id = divId;
        document.getElementById('yt-container').appendChild(p);

        ytPlayers[song.id] = new YT.Player(divId, {
            height: '200', width: '200', videoId: song.ytId,
            playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1 },
            events: {
                'onError': onPlayerError
            }
        });
    });
    debug.innerText = "Players Ready. Waiting for User...";
}

function onPlayerError(event) {
    console.error("YT Error:", event.data);
    debug.innerText = "YT Error Code: " + event.data + " (Check AdBlock)";
}

function playSong(songId) {
    if (!apiReady || !ytPlayers[songId]) return;
    ytPlayers[songId].playVideo();
    debug.innerText = "Playing: " + songId;
}

function stopSong(songId) {
    if (!apiReady || !ytPlayers[songId]) return;
    ytPlayers[songId].pauseVideo();
}

// ==========================================
// 3. INPUTS (Inverted Drag)
// ==========================================
let player = { x: 0, y: 0, size: 8 };
let camera = { zoom: 1, targetZoom: 1 };
let keys = {};
let currentSongId = null;
let time = 0;
let isDragging = false;
let lastMouse = { x: 0, y: 0 };

// START BUTTON LOGIC
startBtn.addEventListener('click', () => {
    userHasInteracted = true;
    startScreen.style.display = 'none';
    debug.innerText = "Audio Unlocked.";
    // Optional: Pre-warm players (mute and play for 0.1s) to ensure they wake up?
    // For now, let's keep it simple.
});

window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
window.dispatchEvent(new Event('resize'));

window.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
window.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);
window.addEventListener('wheel', e => {
    e.preventDefault();
    camera.targetZoom -= e.deltaY * 0.001;
    camera.targetZoom = Math.max(0.2, Math.min(3.0, camera.targetZoom));
}, { passive: false });

// DRAG LOGIC (REVERSED)
canvas.addEventListener('mousedown', e => { isDragging = true; lastMouse = { x: e.clientX, y: e.clientY }; });
window.addEventListener('mouseup', () => isDragging = false);
canvas.addEventListener('mousemove', e => {
    if (!isDragging) return;
    const dx = e.clientX - lastMouse.x;
    const dy = e.clientY - lastMouse.y;
    lastMouse = { x: e.clientX, y: e.clientY };
    
    // REVERSED: Subtracting DX means dragging mouse Right moves the Player Left.
    // This creates the feeling of "Pulling the map Right".
    player.x -= dx / camera.zoom;
    player.y -= dy / camera.zoom;
});

// ==========================================
// 4. RENDER LOOP
// ==========================================
function draw() {
    time += 0.04; 

    // WASD Movement (Standard)
    const speed = 6;
    if (keys['w'] || keys['arrowup']) player.y -= speed / camera.zoom;
    if (keys['s'] || keys['arrowdown']) player.y += speed / camera.zoom;
    if (keys['a'] || keys['arrowleft']) player.x -= speed / camera.zoom;
    if (keys['d'] || keys['arrowright']) player.x += speed / camera.zoom;

    camera.zoom += (camera.targetZoom - camera.zoom) * 0.1;

    // Draw Background
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(canvas.width / 2, canvas.height / 2);
    ctx.scale(camera.zoom, camera.zoom);
    ctx.translate(-player.x, -player.y);

    // Anchors
    ctx.globalCompositeOperation = "screen"; 
    anchors.forEach(anchor => {
        const grad = ctx.createRadialGradient(anchor.x, anchor.y, 0, anchor.x, anchor.y, anchor.radius);
        grad.addColorStop(0, anchor.color);
        grad.addColorStop(1, "rgba(0,0,0,0)");
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(anchor.x, anchor.y, anchor.radius, 0, Math.PI * 2);
        ctx.fill(); 
    });
    ctx.globalCompositeOperation = "source-over";

    // Songs
    let touchingAnySong = false;
    songs.forEach(song => {
        const floatY = song.y + Math.sin(time + song.offset) * 6;
        const dx = player.x - song.x;
        const dy = player.y - floatY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        const isTouching = dist < (35 + player.size);
        const currentRadius = isTouching ? 50 : 35;

        ctx.beginPath();
        ctx.arc(song.x, floatY, currentRadius, 0, Math.PI * 2);
        
        if (isTouching) {
            touchingAnySong = true;
            ctx.shadowBlur = 30; ctx.shadowColor = "white";
            ctx.fillStyle = "white"; ctx.fill(); ctx.shadowBlur = 0;

            if (currentSongId !== song.id && userHasInteracted) {
                if (currentSongId) stopSong(currentSongId);
                playSong(song.id);
                currentSongId = song.id;
                npTitle.innerText = song.title;
                npNote.innerText = song.note;
                npBox.style.display = "block";
            }
        } else {
            ctx.fillStyle = "rgba(255,255,255,0.05)";
            ctx.strokeStyle = "rgba(255,255,255,0.4)";
            ctx.lineWidth = 1.5;
            ctx.fill(); ctx.stroke();
        }

        if (camera.zoom > 0.5) {
             ctx.fillStyle = isTouching ? "black" : "rgba(255,255,255,0.7)";
             ctx.font = isTouching ? "bold 12px Arial" : "11px Arial";
             ctx.textAlign = "center";
             ctx.fillText(song.title, song.x, floatY + currentRadius + 15);
        }
    });

    if (!touchingAnySong && currentSongId !== null) {
        stopSong(currentSongId);
        currentSongId = null;
        npBox.style.display = "none";
    }

    // Player
    ctx.fillStyle = "white"; ctx.beginPath();
    ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2); ctx.fill();

    ctx.restore();
    requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>